<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.15.9"><title>使用BSD socket</title></head> <body> <h1>使用BSD socket</h1>  <p><em>Windows</em></p> <p>2023-03-05</p> <p>Written by: tdtc</p> <p>BSD Socket是标准的套接字规范，那么怎么在windows使用他们呢？</p>
<h1 id="init--clean">Init &#x26; clean</h1>
<p>首先要引用&#x3C;winsock2.h>和ws2_32.lib；
使用struct addrinfo需引用&#x3C;ws2tcpip.h>。</p>
<p>程序头: WSAStartup(),
程序尾: WSACleanup();</p>
<h1 id="code">code</h1>
<blockquote>
<p>以下程序在VC9/VC14.1下编译通过</p>
</blockquote>
<h2 id="客户端程序">客户端程序</h2>
<h3 id="prj1clt">prj1Clt</h3>
<blockquote>
<p>无getaddrinfo版</p>
<blockquote>
<p>注意：InetPton函数只能在Windows Version >=6上实现！</p>
</blockquote>
</blockquote>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#6A737D">// prj1Clt.cpp : This file contains the 'main' function. Program execution begins and ends there.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Networking program is Win version with BSD Socket</span></span>
<span class="line"><span style="color:#6A737D"> * Client side</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * Author: xiaobin</span></span>
<span class="line"><span style="color:#6A737D"> * Date: 2013-12-12</span></span>
<span class="line"><span style="color:#6A737D"> * Modfity: 2020-5-28</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;iostream></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#if</span><span style="color:#B392F0"> _MSC_VER</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 1800</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;tchar.h></span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;winsock2.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;ws2tcpip.h></span></span>
<span class="line"><span style="color:#F97583">#pragma</span><span style="color:#B392F0"> comment</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">lib</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ws2_32.lib"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">#else</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;sys/socket.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;netinet/in.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;arpa/in.h></span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> MAXLINE</span><span style="color:#79B8FF"> 254</span></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_PORT</span><span style="color:#79B8FF"> 3293</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">char*</span><span style="color:#FFAB70"> argv</span><span style="color:#F97583">[]</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8"> 				 sockfd;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8">  sockaddr_in  servaddr;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">					 iStatus;</span></span>
<span class="line"><span style="color:#F97583">	char</span><span style="color:#F97583">				*</span><span style="color:#E1E4E8">sendBuff </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "this is test message!"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#E1E4E8">	WORD wVersionRequested;</span></span>
<span class="line"><span style="color:#E1E4E8">	WSADATA wsaData;</span></span>
<span class="line"><span style="color:#E1E4E8">	wVersionRequested </span><span style="color:#F97583">=</span><span style="color:#B392F0"> MAKEWORD</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> WSAStartup</span><span style="color:#E1E4E8">(wVersionRequested, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">wsaData);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">LOBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#B392F0">		HIBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (argc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Usage: &#x3C;IPaddress></span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	sockfd </span><span style="color:#F97583">=</span><span style="color:#B392F0"> socket</span><span style="color:#E1E4E8">(AF_INET, SOCK_STREAM, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (sockfd </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"socket error</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	/* check Server address */</span></span>
<span class="line"><span style="color:#6A737D">	// inet_pton is win version - InetPton</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">InetPton</span><span style="color:#E1E4E8">(AF_INET, (</span><span style="color:#79B8FF">wchar_t</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">servaddr.sin_addr) </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">		//if (InetPtonA(AF_INET, argv[1], &#x26;servaddr.sin_addr) &#x3C; 0)</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"inet_pton error for </span><span style="color:#79B8FF">%ls</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	/* Set serveraddr */</span></span>
<span class="line"><span style="color:#B392F0">	memset</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">servaddr, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(servaddr));</span></span>
<span class="line"><span style="color:#E1E4E8">	servaddr.sin_family </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AF_INET;</span></span>
<span class="line"><span style="color:#E1E4E8">	servaddr.sin_addr.S_un.S_addr </span><span style="color:#F97583">=</span><span style="color:#B392F0"> inet_addr</span><span style="color:#E1E4E8">((</span><span style="color:#F97583">char</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">)</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"><span style="color:#E1E4E8">	servaddr.sin_port </span><span style="color:#F97583">=</span><span style="color:#B392F0"> htons</span><span style="color:#E1E4E8">(DEFAULT_PORT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s%ls%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Connecting "</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], </span><span style="color:#9ECBFF">" ..."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	/* connect server */</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> connect</span><span style="color:#E1E4E8">(sockfd, (</span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> sockaddr </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">servaddr, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(servaddr));</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		closesocket</span><span style="color:#E1E4E8">(sockfd);</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"connect error</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Writing..."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">	/* Write data */</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> send</span><span style="color:#E1E4E8">(sockfd, sendBuff, (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)</span><span style="color:#B392F0">strlen</span><span style="color:#E1E4E8">(sendBuff), </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"write data error"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Writed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(sockfd);</span></span>
<span class="line"><span style="color:#B392F0">	WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="prj2clt">prj2Clt</h3>
<blockquote>
<p>getaddrinfo版</p>
</blockquote>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#6A737D">// prj2Clt.cpp : Defines the entry point for the console application.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Networking program is Win version with BSD Socket</span></span>
<span class="line"><span style="color:#6A737D"> * Server side</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * Author: xiaobin</span></span>
<span class="line"><span style="color:#6A737D"> * Date: 2020-05-28 07:35</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;iostream></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;winsock2.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;ws2tcpip.h></span></span>
<span class="line"><span style="color:#F97583">#pragma</span><span style="color:#B392F0"> comment</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">lib</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ws2_32.lib"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">#else</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;sys/socket.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;netinet/in.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;arpa/in.h></span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> MAXLINE</span><span style="color:#79B8FF"> 254</span></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_PORT_S</span><span style="color:#9ECBFF"> "3293"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">char*</span><span style="color:#FFAB70"> argv</span><span style="color:#F97583">[]</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8"> 				 sockfd;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> addrinfo      hints;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> addrinfo    	</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">servInfo </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> NULL</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">    				 status;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">					 iStatus;</span></span>
<span class="line"><span style="color:#F97583">	char</span><span style="color:#F97583">				*</span><span style="color:#E1E4E8">sendBuff </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "this is test message!"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#E1E4E8">	WORD wVersionRequested;</span></span>
<span class="line"><span style="color:#E1E4E8">	WSADATA wsaData;</span></span>
<span class="line"><span style="color:#E1E4E8">	wVersionRequested </span><span style="color:#F97583">=</span><span style="color:#B392F0"> MAKEWORD</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> WSAStartup</span><span style="color:#E1E4E8">(wVersionRequested, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">wsaData);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">LOBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#B392F0">		HIBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (argc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Usage: &#x3C;IPaddress></span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	/* Set serveraddr */</span></span>
<span class="line"><span style="color:#B392F0">	memset</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">hints, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(hints));</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_family </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AF_UNSPEC;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_socktype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> SOCK_STREAM;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_flags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AI_PASSIVE;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_protocol </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> IPPROTO_TCP;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	status </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getaddrinfo</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], DEFAULT_PORT_S, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">hints, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">servInfo);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (status </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"getaddrinfo:</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> failed with error: </span><span style="color:#79B8FF">%d\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], status);</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	sockfd </span><span style="color:#F97583">=</span><span style="color:#B392F0"> socket</span><span style="color:#E1E4E8">(servInfo->ai_family, servInfo->ai_socktype, servInfo->ai_protocol);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (sockfd </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"socket error</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s%s%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Connecting "</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], </span><span style="color:#9ECBFF">" ..."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">	/* connect server */</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> connect</span><span style="color:#E1E4E8">(sockfd, servInfo->ai_addr, servInfo->ai_addrlen);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		closesocket</span><span style="color:#E1E4E8">(sockfd);</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"connect error</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	freeaddrinfo</span><span style="color:#E1E4E8">(servInfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Writing..."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">	/* Write data */</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> send</span><span style="color:#E1E4E8">(sockfd, sendBuff, (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)</span><span style="color:#B392F0">strlen</span><span style="color:#E1E4E8">(sendBuff), </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"write data error"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#B392F0">	printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"Writed."</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(sockfd);</span></span>
<span class="line"><span style="color:#B392F0">	WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="服务器端程序">服务器端程序</h2>
<h3 id="prj1srv">prj1Srv</h3>
<blockquote>
<p>无getaddrinfo版</p>
</blockquote>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#6A737D">// prj1Srv.cpp : This file contains the 'main' function. Program execution begins and ends there.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Networking program is Win version with BSD Socket</span></span>
<span class="line"><span style="color:#6A737D"> * Server side</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * Author: xiaobin</span></span>
<span class="line"><span style="color:#6A737D"> * Date: 2012-12-18 23:35</span></span>
<span class="line"><span style="color:#6A737D"> * Modfity: 2023-3-6</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;iostream></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;winsock2.h></span></span>
<span class="line"><span style="color:#F97583">#pragma</span><span style="color:#B392F0"> comment</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">lib</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ws2_32.lib"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">#else</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;sys/socket.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;netinet/in.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;arpa/in.h></span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_BUFLEN</span><span style="color:#79B8FF"> 128</span></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_PORT</span><span style="color:#79B8FF"> 3293</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">char*</span><span style="color:#FFAB70"> argv</span><span style="color:#F97583">[]</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">					srvSock, client;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> sockaddr_in  addrSrv;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">					iStatus;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">					len;</span></span>
<span class="line"><span style="color:#F97583">	char</span><span style="color:#FFAB70">				buff</span><span style="color:#E1E4E8">[DEFAULT_BUFLEN];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#E1E4E8">	WORD wVersionRequested;</span></span>
<span class="line"><span style="color:#E1E4E8">	WSADATA wsaData;</span></span>
<span class="line"><span style="color:#E1E4E8">	wVersionRequested </span><span style="color:#F97583">=</span><span style="color:#B392F0"> MAKEWORD</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> WSAStartup</span><span style="color:#E1E4E8">(wVersionRequested, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">wsaData);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">LOBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#B392F0">		HIBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"><span style="color:#E1E4E8">	</span></span>
<span class="line"><span style="color:#E1E4E8">	srvSock </span><span style="color:#F97583">=</span><span style="color:#B392F0"> socket</span><span style="color:#E1E4E8">(AF_INET, SOCK_STREAM, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	SecureZeroMemory</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">addrSrv, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(addrSrv));</span></span>
<span class="line"><span style="color:#E1E4E8">	addrSrv.sin_family </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AF_INET;</span></span>
<span class="line"><span style="color:#E1E4E8">	addrSrv.sin_addr.S_un.S_addr </span><span style="color:#F97583">=</span><span style="color:#B392F0"> htonl</span><span style="color:#E1E4E8">(INADDR_ANY);</span></span>
<span class="line"><span style="color:#E1E4E8">	addrSrv.sin_port </span><span style="color:#F97583">=</span><span style="color:#B392F0"> htons</span><span style="color:#E1E4E8">(DEFAULT_PORT);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	bind</span><span style="color:#E1E4E8">(srvSock, (</span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> sockaddr </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">addrSrv, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(addrSrv));</span></span>
<span class="line"><span style="color:#B392F0">	listen</span><span style="color:#E1E4E8">(srvSock, </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	len </span><span style="color:#F97583">=</span><span style="color:#F97583"> sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> sockaddr);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	while</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">		client </span><span style="color:#F97583">=</span><span style="color:#B392F0"> accept</span><span style="color:#E1E4E8">(srvSock, (</span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> sockaddr </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">addrSrv, (</span><span style="color:#F97583">int</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">len);</span></span>
<span class="line"><span style="color:#E1E4E8">		iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> recv</span><span style="color:#E1E4E8">(client, buff, DEFAULT_BUFLEN, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">			printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, buff);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(client);</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(srvSock);</span></span>
<span class="line"><span style="color:#B392F0">	WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="prj2srv">prj2Srv</h3>
<blockquote>
<p>getaddrinfo版</p>
</blockquote>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#6A737D">// prj2Srv.cpp : Defines the entry point for the console application.</span></span>
<span class="line"><span style="color:#6A737D">//</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Networking program is Win version with BSD Socket</span></span>
<span class="line"><span style="color:#6A737D"> * Server side</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * Author: xiaobin</span></span>
<span class="line"><span style="color:#6A737D"> * Date: 2020-05-27 23:35</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;iostream></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;winsock2.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;ws2tcpip.h></span></span>
<span class="line"><span style="color:#F97583">#pragma</span><span style="color:#B392F0"> comment</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">lib</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"ws2_32.lib"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">#else</span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;sys/socket.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;netinet/in.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;arpa/in.h></span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_BUFLEN</span><span style="color:#79B8FF"> 128</span></span>
<span class="line"><span style="color:#F97583">#define</span><span style="color:#B392F0"> DEFAULT_PORT_S</span><span style="color:#9ECBFF"> "3293"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">char*</span><span style="color:#FFAB70"> argv</span><span style="color:#F97583">[]</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">						srvSock, client;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> addrinfo     	hints;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> addrinfo    		</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">servInfo </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> NULL</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">	struct</span><span style="color:#E1E4E8"> sockaddr_storage clientAddr;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">    					status;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">						iStatus;</span></span>
<span class="line"><span style="color:#F97583">	int</span><span style="color:#E1E4E8">						len;</span></span>
<span class="line"><span style="color:#F97583">	char</span><span style="color:#FFAB70">					buff</span><span style="color:#E1E4E8">[DEFAULT_BUFLEN];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#E1E4E8">	WORD wVersionRequested;</span></span>
<span class="line"><span style="color:#E1E4E8">	WSADATA wsaData;</span></span>
<span class="line"><span style="color:#E1E4E8">	wVersionRequested </span><span style="color:#F97583">=</span><span style="color:#B392F0"> MAKEWORD</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> WSAStartup</span><span style="color:#E1E4E8">(wVersionRequested, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">wsaData);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">LOBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#B392F0">		HIBYTE</span><span style="color:#E1E4E8">(wsaData.wVersion) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (argc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Usage: &#x3C;IPaddress></span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">		exit</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	memset</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">hints, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(hints));</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_family </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AF_UNSPEC;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_socktype </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> SOCK_STREAM;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_flags </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> AI_PASSIVE;</span></span>
<span class="line"><span style="color:#E1E4E8">	hints.ai_protocol </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> IPPROTO_TCP;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	status </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getaddrinfo</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], DEFAULT_PORT_S, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">hints, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">servInfo);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8"> (status </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">		printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"getaddrinfo:</span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> failed with error: </span><span style="color:#79B8FF">%d\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], status);</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">	srvSock </span><span style="color:#F97583">=</span><span style="color:#B392F0"> socket</span><span style="color:#E1E4E8">(servInfo->ai_family, servInfo->ai_socktype, servInfo->ai_protocol);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	bind</span><span style="color:#E1E4E8">(srvSock, servInfo->ai_addr, (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)servInfo->ai_addrlen);</span></span>
<span class="line"><span style="color:#B392F0">	listen</span><span style="color:#E1E4E8">(srvSock, </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">	freeaddrinfo</span><span style="color:#E1E4E8">(servInfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	while</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">		len </span><span style="color:#F97583">=</span><span style="color:#F97583"> sizeof</span><span style="color:#E1E4E8">(clientAddr);</span></span>
<span class="line"><span style="color:#E1E4E8">		client </span><span style="color:#F97583">=</span><span style="color:#B392F0"> accept</span><span style="color:#E1E4E8">(srvSock, (</span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> sockaddr </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">clientAddr, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">len);</span></span>
<span class="line"><span style="color:#E1E4E8">		iStatus </span><span style="color:#F97583">=</span><span style="color:#B392F0"> recv</span><span style="color:#E1E4E8">(client, buff, DEFAULT_BUFLEN, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8"> (iStatus </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">			printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, buff);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">#ifdef</span><span style="color:#B392F0"> _WIN32</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(client);</span></span>
<span class="line"><span style="color:#B392F0">	closesocket</span><span style="color:#E1E4E8">(srvSock);</span></span>
<span class="line"><span style="color:#B392F0">	WSACleanup</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">	return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h1 id="参考文献">参考文献</h1>
<ul>
<li>
<p><a href="https://docs.microsoft.com/zh-cn/windows/win32/winsock/finished-server-and-client-code">Running the Winsock Client and Server Code Sample</a> - microsoft</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo">getaddrinfo function</a> - microsoft</p>
</li>
<li>
<p><a href="https://blog.csdn.net/xiaobin_HLJ80/article/details/8826313">5.1 getaddrinfo</a> - xiaobin</p>
</li>
<li>
<p><a href="https://tdtc-hrb.github.io/csdn/post/c-bsd_socket/">网络编程client和server</a> - xiaobin</p>
</li>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/ms742213(v=vs.85).aspx">WSAStartup</a> - Microsoft Developer Network</p>
</li>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/ms741549(v=vs.85).aspx">WSACleanup</a> - Microsoft Developer Network</p>
</li>
<li>
<p><a href="http://msdn.microsoft.com/en-us/library/cc805844(v=vs.85).aspx">InetPton</a> - Microsoft Developer Network</p>
</li>
</ul>  <footer> <a href="https://tdtc-hrb.github.io/blog-frontend">blog-frontend</a> <a href="https://tdtc-hrb.github.io/com-vc">com-vc</a> <a href="https://tdtc-hrb.github.io/css-tws">css-tws</a> <a href="https://tdtc-hrb.github.io/ops-win">ops-win</a> </footer> </body></html>