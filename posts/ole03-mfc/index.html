<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.16.9"><title>The OLE clipboard</title></head> <body> <h1>The OLE clipboard</h1>  <p><em>Using Alternative Storage Media</em></p> <p>2025-12-10</p> <p>Written by: xiaobin</p> <p>Remember, a data object is a COM object that implements the IDataObject interface.</p>
<p><img src="https://github.com/tdtc-hrb/csdn/raw/master/images/figure19.1_mfc2.png" alt="Transferring data through the OLE clipboard."></p>
<ol>
<li>The data provider uses OleSetClipboard to place a data object on the clipboard.</li>
<li>The data consumer uses OleGetClipboard to retrieve the IDataObject interface pointer.</li>
<li>The data consumer requests data from the data object.</li>
<li>The data object providers data to the data consumer.</li>
</ol>
<h3 id="provider-and-consumer">provider and consumer</h3>
<p>MFC’s OLE clipboard support is concentrated in two classes.</p>
<ul>
<li><a href="https://tdtc-hrb.github.io/com-vc/posts/ole04-mfc">COleDataSource</a></li>
<li><a href="https://tdtc-hrb.github.io/com-vc/posts/ole05-mfc">COleDataObject</a></li>
</ul>
<p>The first, COleDataSource, models the provider side of clipboard operations.<br>
The second, COleDataObject, models the consumer side.</p>
<h4 id="ole-support">OLE support</h4>
<p>Add the following to the InitInstance() in &#x3C;ProjName.cpp>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>    // Initialize OLE libraries</span></span>
<span class="line"><span>    if (!AfxOleInit())</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>        AfxMessageBox(_T("OLE initialization failed.  Make sure that the OLE libraries are the correct version.")); // IDP_OLE_INIT_FAILED</span></span>
<span class="line"><span>        return FALSE;</span></span>
<span class="line"><span>    }</span></span></code></pre>
<p>Resolving the “CoInitialize has not been called”.</p>
<h4 id="get-data-and-set-data">get data and set data</h4>
<p>Two structures play key roles in the operation of SetData and GetData:</p>
<ul>
<li>FORMATETC</li>
<li>STGMEDIUM</li>
</ul>
<h3 id="example">example</h3>
<p>CFile provider:</p>
<ul>
<li>TYMED_HGLOBAL</li>
<li>TYMED_FILE</li>
<li>TYMED_MFPICT</li>
<li>TYMED_ISTREAM</li>
</ul>
<h4 id="provider-side">provider side</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>    USES_CONVERSION;    // A2W usage</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    char szText[] = "Hello, world";</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    TCHAR szPath[MAX_PATH], szFileName[MAX_PATH];</span></span>
<span class="line"><span>    ::GetTempPath(sizeof(szPath) / sizeof(TCHAR), szPath);</span></span>
<span class="line"><span>    ::GetTempFileName(szPath, _T("tmp"), 0, szFileName);</span></span>
<span class="line"><span>    CFile file;</span></span>
<span class="line"><span>    if (file.Open(szFileName, CFile::modeCreate | CFile::modeWrite)) {</span></span>
<span class="line"><span>        file.Write(szText, ::lstrlen(A2W(szText)) + 1);</span></span>
<span class="line"><span>        file.Close();</span></span>
<span class="line"><span>        LPWSTR pwszFileName = (LPWSTR) ::CoTaskMemAlloc(MAX_PATH * sizeof(WCHAR));</span></span>
<span class="line"><span>#ifdef UNICODE</span></span>
<span class="line"><span>        ::lstrcpy(pwszFileName, szFileName);</span></span>
<span class="line"><span>#else</span></span>
<span class="line"><span>        ::MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, szFileName, -1, pwszFileName, MAX_PATH);</span></span>
<span class="line"><span>#endif</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        FORMATETC fe = {</span></span>
<span class="line"><span>            CF_TEXT, NULL, DVASPECT_CONTENT, -1, TYMED_FILE</span></span>
<span class="line"><span>        };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        STGMEDIUM stgm;</span></span>
<span class="line"><span>        stgm.tymed = TYMED_FILE;</span></span>
<span class="line"><span>        stgm.lpszFileName = pwszFileName;</span></span>
<span class="line"><span>        stgm.pUnkForRelease = NULL;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        COleDataSource* pods = new COleDataSource;</span></span>
<span class="line"><span>        pods->CacheData(CF_TEXT, &#x26;stgm, &#x26;fe);</span></span>
<span class="line"><span>        pods->SetClipboard();</span></span>
<span class="line"><span>    }</span></span></code></pre>
<h4 id="consumer-side">consumer side</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>    char szText[BUFLEN];</span></span>
<span class="line"><span>    STGMEDIUM stgm;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    FORMATETC fe = {</span></span>
<span class="line"><span>        CF_TEXT, NULL, DVASPECT_CONTENT, -1, TYMED_FILE</span></span>
<span class="line"><span>    };</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    COleDataObject odo;</span></span>
<span class="line"><span>    odo.AttachClipboard();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (odo.GetData(CF_TEXT, &#x26;stgm, &#x26;fe) &#x26;&#x26; stgm.tymed == TYMED_FILE) {</span></span>
<span class="line"><span>        TCHAR szFileName[MAX_PATH];</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#ifdef UNICODE</span></span>
<span class="line"><span>        ::lstrcpy(szFileName, stgm.lpszFileName);</span></span>
<span class="line"><span>#else</span></span>
<span class="line"><span>        ::WideCharToMultiByte(CP_ACP, 0, stgm.lpszFileName,</span></span>
<span class="line"><span>            -1, szFileName, sizeof(szFileName) / sizeof(TCHAR), NULL, NULL);</span></span>
<span class="line"><span>#endif</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        CFile file;</span></span>
<span class="line"><span>        if (file.Open(szFileName, CFile::modeRead)) {</span></span>
<span class="line"><span>            ULONGLONG ulSize = file.GetLength();</span></span>
<span class="line"><span>            if (ulSize &#x3C; BUFLEN)</span></span>
<span class="line"><span>                file.Read(szText, (UINT)ulSize);</span></span>
<span class="line"><span>            file.Close();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        ::ReleaseStgMedium(&#x26;stgm);</span></span>
<span class="line"><span>    }</span></span></code></pre>
<p>Macro define:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>#define BUFLEN 4096</span></span></code></pre>
<h2 id="ref">Ref</h2>
<ul>
<li><a href="https://assets.ctfassets.net/9pcn2syx7zns/6ejGpuR3LJdenVQWDCe23W/d152db4718309d396d07aa8b444a541e/mfc2.pdf">19.2. The OLE Clipboard</a></li>
</ul>  <footer> <a href="https://tdtc-hrb.github.io/blog-frontend">blog-frontend</a> <a href="https://tdtc-hrb.github.io/com-vc">com-vc</a> <a href="https://tdtc-hrb.github.io/css-tws">css-tws</a> <a href="https://tdtc-hrb.github.io/ops-win">ops-win</a> </footer> </body></html>